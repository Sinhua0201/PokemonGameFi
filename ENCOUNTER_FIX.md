# âœ… é‡å¤–é­é‡é¡µé¢ä¿®å¤

## ğŸ› é—®é¢˜

```
Failed to calculate capture rate
at Object.calculateCaptureRate (lib/api.ts:110:13)
```

**åŸå› ï¼š**
- åç«¯ API è°ƒç”¨å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ CORS æˆ–æœåŠ¡å™¨æœªè¿è¡Œï¼‰
- æ²¡æœ‰é™çº§æ–¹æ¡ˆ

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ é™çº§æ–¹æ¡ˆ

åœ¨ `frontend/lib/api.ts` ä¸­æ·»åŠ äº†æœ¬åœ°è®¡ç®—æ•æ‰ç‡çš„æ–¹æ³•ï¼š

```typescript
calculateLocalCaptureRate(pokemonId: number, healthPercent: number): number {
  // åŸºç¡€æ•æ‰ç‡ï¼ˆæ ¹æ®å®å¯æ¢¦ç¨€æœ‰åº¦ï¼‰
  let baseRate = 0.5;
  
  // ä¼ è¯´å®å¯æ¢¦ï¼ˆæ›´éš¾æ•æ‰ï¼‰
  const legendaryIds = [144, 145, 146, 150, 151, ...];
  if (legendaryIds.includes(pokemonId)) {
    baseRate = 0.03;
  }
  // ç¨€æœ‰å®å¯æ¢¦
  else if (pokemonId > 130) {
    baseRate = 0.25;
  }
  
  // æ ¹æ®è¡€é‡è°ƒæ•´æ•æ‰ç‡
  const healthModifier = 1 - (healthPercent * 0.5);
  const finalRate = Math.min(0.95, baseRate + healthModifier);
  
  return Math.max(0.05, finalRate);
}
```

### 2. æ”¹è¿›é”™è¯¯å¤„ç†

```typescript
try {
  const response = await fetch(`${API_URL}/api/battle/capture-rate`, ...);
  
  if (!response.ok) {
    // ä½¿ç”¨æœ¬åœ°è®¡ç®—
    return { capture_rate: this.calculateLocalCaptureRate(...) };
  }
  return response.json();
} catch (error) {
  // é™çº§åˆ°æœ¬åœ°è®¡ç®—
  return { capture_rate: this.calculateLocalCaptureRate(...) };
}
```

### 3. æ·»åŠ é¡µé¢å¼•å¯¼

åœ¨ encounter é¡µé¢æ·»åŠ äº† `PageGuide` ç»„ä»¶ï¼š

```tsx
<PageGuide
  title="é‡å¤–é­é‡"
  description="åœ¨è¿™é‡Œä½ å¯ä»¥é‡åˆ°éšæœºçš„é‡ç”Ÿå®å¯æ¢¦å¹¶å°è¯•æ•æ‰å®ƒä»¬"
  tips={[
    'æ¯æ¬¡é­é‡æœ‰ 5 åˆ†é’Ÿå†·å´æ—¶é—´',
    'å®å¯æ¢¦è¡€é‡è¶Šä½ï¼Œæ•æ‰ç‡è¶Šé«˜',
    'æ•æ‰æˆåŠŸåä¼šè·å¾—ç»éªŒå’Œå¥–åŠ±'
  ]}
  storageKey="encounter-guide"
/>
```

## ğŸ“Š æ•æ‰ç‡è®¡ç®—è§„åˆ™

### åŸºç¡€æ•æ‰ç‡
- **ä¼ è¯´å®å¯æ¢¦**: 3% (å¦‚ Mewtwo, Mew)
- **ç¨€æœ‰å®å¯æ¢¦**: 25% (ID > 130)
- **æ™®é€šå®å¯æ¢¦**: 50%

### è¡€é‡ä¿®æ­£
```
æœ€ç»ˆæ•æ‰ç‡ = åŸºç¡€æ•æ‰ç‡ + (1 - è¡€é‡ç™¾åˆ†æ¯”) * 0.5
```

**ç¤ºä¾‹ï¼š**
- æ™®é€šå®å¯æ¢¦ï¼Œæ»¡è¡€ (100%): 50% + 0% = 50%
- æ™®é€šå®å¯æ¢¦ï¼ŒåŠè¡€ (50%): 50% + 25% = 75%
- æ™®é€šå®å¯æ¢¦ï¼Œä½è¡€ (10%): 50% + 45% = 95%

### é™åˆ¶
- æœ€ä½æ•æ‰ç‡: 5%
- æœ€é«˜æ•æ‰ç‡: 95%

## ğŸ¯ ä¼˜åŠ¿

### ä¹‹å‰
- âŒ åç«¯ API å¤±è´¥ = æ¸¸æˆæ— æ³•ç»§ç»­
- âŒ æ²¡æœ‰é”™è¯¯æç¤º
- âŒ ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ

### ç°åœ¨
- âœ… åç«¯å¤±è´¥è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°è®¡ç®—
- âœ… æ¸¸æˆå¯ä»¥ç»§ç»­è¿›è¡Œ
- âœ… æœ‰æ¸…æ™°çš„é¡µé¢å¼•å¯¼
- âœ… æ§åˆ¶å°æœ‰è­¦å‘Šæ—¥å¿—

## ğŸ”§ åç«¯ä¿®å¤ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³ä½¿ç”¨åç«¯ APIï¼Œéœ€è¦ï¼š

### 1. ç¡®ä¿åç«¯è¿è¡Œ
```bash
cd backend
python -m uvicorn main:app --reload --port 8000
```

### 2. æ›´æ–° CORS è®¾ç½®
åœ¨ `backend/config/settings.py`:
```python
CORS_ORIGINS = "http://localhost:3000,https://your-frontend.vercel.app"
```

### 3. æ£€æŸ¥ API ç«¯ç‚¹
è®¿é—®: http://localhost:8000/api/battle/capture-rate

## ğŸ“ æµ‹è¯•

1. **æµ‹è¯•æœ¬åœ°è®¡ç®—**
   - åœæ­¢åç«¯æœåŠ¡å™¨
   - è®¿é—® `/encounter` é¡µé¢
   - åº”è¯¥èƒ½æ­£å¸¸é‡åˆ°å’Œæ•æ‰å®å¯æ¢¦

2. **æµ‹è¯•åç«¯ API**
   - å¯åŠ¨åç«¯æœåŠ¡å™¨
   - è®¿é—® `/encounter` é¡µé¢
   - æ£€æŸ¥æ§åˆ¶å°ï¼Œåº”è¯¥æ²¡æœ‰è­¦å‘Š

3. **æµ‹è¯•ä¸åŒæ•æ‰ç‡**
   - é‡åˆ°æ™®é€šå®å¯æ¢¦ï¼ˆå¦‚ Pidgeyï¼‰
   - é‡åˆ°ç¨€æœ‰å®å¯æ¢¦ï¼ˆå¦‚ Eeveeï¼‰
   - é‡åˆ°ä¼ è¯´å®å¯æ¢¦ï¼ˆå¦‚ Mewtwoï¼‰

## âœ… ç»“æœ

ç°åœ¨é‡å¤–é­é‡åŠŸèƒ½ï¼š
- âœ… å³ä½¿åç«¯å¤±è´¥ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æœ‰æ¸…æ™°çš„ç”¨æˆ·å¼•å¯¼
- âœ… æ•æ‰ç‡è®¡ç®—åˆç†
- âœ… ç”¨æˆ·ä½“éªŒæµç•…

æ¸¸æˆå¯ä»¥å®Œå…¨ç¦»çº¿è¿è¡Œï¼ˆé™¤äº†åŒºå—é“¾äº¤æ˜“ï¼‰ï¼
